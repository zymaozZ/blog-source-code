(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{345:function(t,e,s){"use strict";s.r(e);var r=s(4),a=Object(r.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),s("p",[t._v("用户发布的视频文章中，有的是超清视频。文件就很大，浏览时获取视频就会很慢。")]),t._v(" "),s("h2",{attrs:{id:"需求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#需求"}},[t._v("#")]),t._v(" 需求")]),t._v(" "),s("ul",[s("li",[t._v("视频上传成功之后，对视频进行转码。不影响浏览体验的同时，希望视频尽量小。")])]),t._v(" "),s("h2",{attrs:{id:"思路和调研"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#思路和调研"}},[t._v("#")]),t._v(" 思路和调研")]),t._v(" "),s("ul",[s("li",[t._v("ffmpeg 可以对视频进行转码（视频上传成功后）")])]),t._v(" "),s("h2",{attrs:{id:"实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[t._v("#")]),t._v(" 实现")]),t._v(" "),s("ul",[s("li",[t._v("设计两类 redis的key。一个是视频的"),s("code",[t._v("list")]),t._v("，一个category_id 的"),s("code",[t._v("zset")]),t._v("，每发一篇视频文章就往对应的list:{category_id)中 push 文章id；另一个是 user_id 的"),s("code",[t._v("zset")]),t._v("，"),s("code",[t._v("member")]),t._v(" 为 category_id, "),s("code",[t._v("score")]),t._v(" 为 用户看过的 list:{category_id} 的 offset。用户每次请求视频文章接口，先拿offset，再"),s("code",[t._v("lrange key offset expectedCount")])]),t._v(" "),s("li",[t._v("用户每次请求接口，从redis 的 list:{category_id}中取出10个，并且记录下用户看到了哪里（offset），已看完的置为负数。（没有取够10个时，会用zrangebyscore，找出未看完的offset最小那个category_id，递归继续取。如果全部取完了。就将所有category_id的"),s("code",[t._v("zset")]),t._v("重置回初始状态）")])])])}),[],!1,null,null,null);e.default=a.exports}}]);